# 后端API接口定义

- type: Backend
  id: API-POST-Login
  route: POST /api/auth/login
  description: 处理用户账号密码登录请求
  input:
    type: JSON
    body:
      account: string
      password: string
      agreeToTerms: boolean
  output:
    success:
      statusCode: 200
      body: { userId: "uuid", token: "jwt", username: "string" }
    error:
      - statusCode: 400
        body: { error: "Invalid input format." }
      - statusCode: 401
        body: { error: "Invalid username or password." }
      - statusCode: 403
        body: { error: "Please agree to the terms of service." }
      - statusCode: 404
        body: { error: "User not found." }
  dependencies:
    - DB-FindUserByPhone
    - DB-FindUserByEmail
    - DB-FindUserByUsername
    - DB-VerifyPassword
  acceptanceCriteria:
    - 当接收到合法且已注册的数据时，应返回200 OK
    - 当账号或密码错误时，应返回401 Unauthorized
    - 当用户未同意服务协议时，应返回403 Forbidden
    - 当用户不存在时，应返回404 Not Found
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

- type: Backend
  id: API-POST-SendVerificationCode
  route: POST /api/auth/send-verification-code
  description: 发送手机验证码
  input:
    type: JSON
    body:
      phoneNumber: string
      type: string
  output:
    success:
      statusCode: 200
      body: { message: "Verification code sent successfully." }
    error:
      - statusCode: 400
        body: { error: "Invalid phone number format." }
      - statusCode: 429
        body: { error: "Too many requests. Please try again later." }
  dependencies:
    - DB-CreateVerificationCode
  acceptanceCriteria:
    - 当接收到合法的手机号时，应返回200 OK并发送验证码
    - 当手机号格式不正确时，应返回400 Bad Request
    - 当请求过于频繁时，应返回429 Too Many Requests
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

- type: Backend
  id: API-POST-LoginWithCode
  route: POST /api/auth/login-with-code
  description: 处理用户验证码登录请求
  input:
    type: JSON
    body:
      phoneNumber: string
      verificationCode: string
      agreeToTerms: boolean
  output:
    success:
      statusCode: 200
      body: { userId: "uuid", token: "jwt", username: "string" }
    error:
      - statusCode: 400
        body: { error: "Invalid input format." }
      - statusCode: 401
        body: { error: "Invalid verification code." }
      - statusCode: 403
        body: { error: "Please agree to the terms of service." }
      - statusCode: 404
        body: { error: "User not found." }
  dependencies:
    - DB-FindUserByPhone
    - DB-VerifyCode
  acceptanceCriteria:
    - 当接收到合法且已注册的数据时，应返回200 OK
    - 当验证码错误时，应返回401 Unauthorized
    - 当用户未同意服务协议时，应返回403 Forbidden
    - 当用户不存在时，应返回404 Not Found
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

- type: Backend
  id: API-POST-RegisterStep1
  route: POST /api/auth/register-step1
  description: 处理注册第一步 - 验证手机号和验证码
  input:
    type: JSON
    body:
      phoneNumber: string
      verificationCode: string
  output:
    success:
      statusCode: 200
      body: { tempToken: "string", maskedPhone: "string" }
    error:
      - statusCode: 400
        body: { error: "Invalid phone number format." }
      - statusCode: 401
        body: { error: "Invalid verification code." }
  dependencies:
    - DB-VerifyCode
  acceptanceCriteria:
    - 当接收到合法的手机号和正确的验证码时，应返回200 OK
    - 当手机号格式不正确时，应返回400 Bad Request
    - 当验证码错误时，应返回401 Unauthorized
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

- type: Backend
  id: API-POST-RegisterStep2
  route: POST /api/auth/register-step2
  description: 处理注册第二步 - 设置密码
  input:
    type: JSON
    body:
      tempToken: string
      password: string
      confirmPassword: string
  output:
    success:
      statusCode: 201
      body: { userId: "uuid", token: "jwt", message: "Registration successful." }
    error:
      - statusCode: 400
        body: { error: "Password does not meet requirements." }
      - statusCode: 409
        body: { error: "Passwords do not match." }
      - statusCode: 401
        body: { error: "Invalid or expired token." }
  dependencies:
    - DB-CreateUser
  acceptanceCriteria:
    - 当接收到合法的密码且两次输入一致时，应返回201 Created
    - 当密码不符合要求时，应返回400 Bad Request
    - 当两次密码不一致时，应返回409 Conflict
    - 当临时令牌无效或过期时，应返回401 Unauthorized
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

- type: Backend
  id: API-GET-Orders
  route: GET /api/orders
  description: 获取当前用户的订单列表，支持按状态筛选和分页。
  input:
    type: QueryParams
    params:
      - name: status
        type: string
        description: "订单状态筛选 (all, pending_travel, pending_payment, pending_review)"
      - name: page
        type: integer
        description: "页码"
      - name: pageSize
        type: integer
        description: "每页数量"
  output:
    success:
      statusCode: 200
      body: {
        orders: [
          {
            orderId: "uuid",
            productType: "string",
            productTitle: "string",
            orderDate: "date",
            totalAmount: "float",
            orderStatus: "string"
          }
        ],
        pagination: {
          currentPage: "integer",
          totalPages: "integer",
          totalCount: "integer"
        }
      }
    error:
      - statusCode: 401
        body: { error: "Unauthorized. Please login." }
  dependencies:
    - DB-FindOrdersByUserId
  acceptanceCriteria:
    - 成功请求后应返回200 OK及订单列表和分页信息。
    - 未登录用户请求应返回401 Unauthorized。
  changeLog:
    - date: "2025-11-15"
      description: "初始创建。"

- type: Backend
  id: API-GET-OrderById
  route: GET /api/orders/:orderId
  description: 获取指定ID的订单详情。
  input:
    type: PathParams
    params:
      - name: orderId
        type: string
        description: "订单的唯一标识符"
  output:
    success:
      statusCode: 200
      body: {
        orderId: "uuid",
        orderStatus: "string",
        productInfo: {},
        travelerInfo: [],
        contactInfo: {},
        priceDetails: {},
        actions: ["cancel", "invoice"]
      }
    error:
      - statusCode: 401
        body: { error: "Unauthorized." }
      - statusCode: 403
        body: { error: "Forbidden. You do not have permission to view this order." }
      - statusCode: 404
        body: { error: "Order not found." }
  dependencies:
    - DB-FindOrderById
  acceptanceCriteria:
    - 成功请求后应返回200 OK及完整的订单详情。
    - 如果订单不属于当前用户，应返回403 Forbidden。
    - 如果订单ID不存在，应返回404 Not Found。
  changeLog:
    - date: "2025-11-15"
      description: "初始创建。"

- type: Backend
  id: API-POST-CancelOrder
  route: POST /api/orders/:orderId/cancel
  description: 取消一个指定的订单。
  input:
    type: PathParams
    params:
      - name: orderId
        type: string
        description: "订单的唯一标识符"
  output:
    success:
      statusCode: 200
      body: { message: "Order cancelled successfully." }
    error:
      - statusCode: 400
        body: { error: "Order cannot be cancelled in its current state." }
      - statusCode: 403
        body: { error: "Forbidden." }
      - statusCode: 404
        body: { error: "Order not found." }
  dependencies:
    - DB-FindOrderById
    - DB-UpdateOrderStatus
  acceptanceCriteria:
    - 成功取消后应返回200 OK。
    - 如果订单状态不允许取消，应返回400 Bad Request。
  changeLog:
    - date: "2025-11-15"
      description: "初始创建。"

- type: Backend
  id: API-GET-OrderAsPdf
  route: GET /api/orders/:orderId/download
  description: 下载指定订单的PDF版本。
  input:
    type: PathParams
    params:
      - name: orderId
        type: string
        description: "订单的唯一标识符"
  output:
    success:
      statusCode: 200
      headers: { "Content-Type": "application/pdf" }
      body: "PDF file stream"
    error:
      - statusCode: 404
        body: { error: "Order not found or PDF generation failed." }
  dependencies:
    - DB-FindOrderById
  acceptanceCriteria:
    - 成功请求后应返回200 OK及PDF文件流。
  changeLog:
    - date: "2025-11-15"
      description: "初始创建。"