# 后端API接口定义

- type: Backend
  id: API-POST-Login
  route: POST /api/auth/login
  description: 处理用户账号密码登录请求
  input:
    type: JSON
    body:
      account: string
      password: string
      agreeToTerms: boolean
  output:
    success:
      statusCode: 200
      body: { userId: "uuid", token: "jwt", username: "string" }
    error:
      - statusCode: 400
        body: { error: "Invalid input format." }
      - statusCode: 401
        body: { error: "Invalid username or password." }
      - statusCode: 403
        body: { error: "Please agree to the terms of service." }
      - statusCode: 404
        body: { error: "User not found." }
  dependencies:
    - DB-FindUserByPhone
    - DB-FindUserByEmail
    - DB-FindUserByUsername
    - DB-VerifyPassword
  acceptanceCriteria:
    - 当接收到合法且已注册的数据时，应返回200 OK
    - 当账号或密码错误时，应返回401 Unauthorized
    - 当用户未同意服务协议时，应返回403 Forbidden
    - 当用户不存在时，应返回404 Not Found
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

 

- type: Backend
  id: API-GET-AirportSuggest
  route: GET /api/airports/suggest?query={keyword}
  description: 城市/机场联想查询
  input:
    type: QueryString
    params:
      query: string
  output:
    success:
      statusCode: 200
      body:
        suggestions:
          - { city: "上海", cityCode: "SHA", airport: "浦东国际机场", airportCode: "PVG", hot: true }
    error:
      - statusCode: 400
        body: { error: "Invalid query keyword." }
      - statusCode: 500
        body: { error: "Service unavailable." }
  dependencies:
    - DB-GetAirportSuggest
  acceptanceCriteria:
    - 输入合法关键词返回不超过20条联想结果
    - 异常时返回对应错误码与信息
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：机场联想接口"

- type: Backend
  id: API-GET-FlightsSearch
  route: GET /api/flights/search
  description: 航班搜索（国内）
  input:
    type: QueryString
    params:
      trip: enum(oneway, round, multi)
      from: string
      to: string
      departDate: date
      returnDate: date
      adults: number
      children: number
      infants: number
      cabin: enum(economy, premium, business, first)
      directOnly: boolean
  output:
    success:
      statusCode: 200
      body:
        flights:
          - {
              id: "string",
              carrier: "MU",
              flightNo: "MU5101",
              from: { airport: "虹桥", code: "SHA", terminal: "T2", time: "08:00" },
              to: { airport: "首都", code: "BJS", terminal: "T3", time: "10:10" },
              duration: "2h10m",
              punctuality: 0.92,
              meals: true,
              packages: [
                { id: "pkg1", name: "特价", cabin: "Y", price: 500, refundable: false, baggage: { carry: 5, checkin: 0 } },
                { id: "pkg2", name: "可退改", cabin: "Y", price: 620, refundable: true, baggage: { carry: 5, checkin: 20 } }
              ]
            }
    error:
      - statusCode: 400
        body: { error: "Invalid search conditions." }
      - statusCode: 500
        body: { error: "Service unavailable." }
  dependencies:
    - DB-SearchFlights
  acceptanceCriteria:
    - 支持单程/往返/多程搜索参数并返回航班与套餐
    - 直飞筛选为true时仅返回直飞航班
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：航班搜索接口"

- type: Backend
  id: API-GET-FlightDetails
  route: GET /api/flights/{flightId}/details?date={date}
  description: 航班详情信息
  input:
    type: PathAndQuery
    path:
      flightId: string
    query:
      date: date
  output:
    success:
      statusCode: 200
      body:
        details:
          { baggage: { carry: 5, checkin: 20 }, wifi: true, meals: true, rules: [ { cabin: "Y", refundFee: 200, changeFee: 100 } ] }
    error:
      - statusCode: 404
        body: { error: "Flight not found." }
      - statusCode: 500
        body: { error: "Service unavailable." }
  dependencies:
    - DB-GetFlightDetails
    - DB-GetFareRules
    - DB-GetBaggagePolicy
  acceptanceCriteria:
    - 返回航段与服务信息、票规摘要与价格明细
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：航班详情接口"

- type: Backend
  id: API-POST-CreateOrder
  route: POST /api/orders
  description: 创建机票订单
  input:
    type: JSON
    body:
      flightId: string
      packageId: string
      passengers: [ { name: string, type: enum(adult, child, infant), documentType: string, documentNo: string, birthday?: date } ]
      contact: { phone: string, email?: string }
      invoice?: { type: string, title?: string }
  output:
    success:
      statusCode: 201
      body: { orderId: "string", amount: number, status: "pending_payment" }
    error:
      - statusCode: 409
        body: { error: "Inventory not enough." }
      - statusCode: 412
        body: { error: "Price changed.", latestPrice: number }
      - statusCode: 500
        body: { error: "Service unavailable." }
  dependencies:
    - DB-CheckAndLockInventory
    - DB-CheckLatestPrice
    - DB-CreateOrder
  acceptanceCriteria:
    - 当库存充足且价格未变更时返回201并生成订单
    - 库存不足或价格变更时返回相应错误码
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：创建订单接口"

- type: Backend
  id: API-GET-Order
  route: GET /api/orders/{orderId}
  description: 查询订单详情
  input:
    type: Path
    path:
      orderId: string
  output:
    success:
      statusCode: 200
      body: { orderId: "string", status: "pending_payment", passengers: [], amount: 620 }
    error:
      - statusCode: 404
        body: { error: "Order not found." }
  dependencies:
    - DB-GetOrderById
  acceptanceCriteria:
    - 返回订单基础信息、乘机人、价格、状态等
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：订单查询接口"

- type: Backend
  id: API-POST-PayOrder
  route: POST /api/orders/{orderId}/pay
  description: 创建支付并跳转第三方支付渠道（占位）
  input:
    type: JSONAndPath
    path:
      orderId: string
    body:
      method: enum(alipay, wechat, bank, unionpay)
  output:
    success:
      statusCode: 200
      body: { paymentId: "string", redirectUrl: "string" }
    error:
      - statusCode: 410
        body: { error: "Payment timeout." }
      - statusCode: 404
        body: { error: "Order not found." }
  dependencies:
    - DB-CreatePaymentRecord
  acceptanceCriteria:
    - 成功返回支付记录与跳转URL（占位），失败返回合理错误码
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：订单支付接口"

- type: Backend
  id: API-GET-OrderStatus
  route: GET /api/orders/{orderId}/status
  description: 查询订单状态
  input:
    type: Path
    path:
      orderId: string
  output:
    success:
      statusCode: 200
      body: { status: "pending_payment" }
  dependencies:
    - DB-GetOrderById
  acceptanceCriteria:
    - 返回订单当前状态用于页面轮询或回调确认
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：订单状态接口"

- type: Backend
  id: API-GET-Ticket
  route: GET /api/orders/{orderId}/ticket
  description: 查询电子客票信息
  input:
    type: Path
    path:
      orderId: string
  output:
    success:
      statusCode: 200
      body: { ticketNo: "string", issuedAt: "datetime", itinerary: {} }
    error:
      - statusCode: 404
        body: { error: "Ticket not found." }
  dependencies:
    - DB-GetOrderById
  acceptanceCriteria:
    - 返回电子客票号与行程详情
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：电子客票接口"

- type: Backend
  id: API-GET-Orders
  route: GET /api/orders
  description: 查询我的订单列表
  input:
    type: QueryString
    params:
      page: number
      pageSize: number
      status?: string
  output:
    success:
      statusCode: 200
      body: { items: [], page: 1, pageSize: 10, total: 0 }
  dependencies:
    - DB-ListOrders
  acceptanceCriteria:
    - 返回订单列表与分页信息，支持状态过滤
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：订单列表接口"

- type: Backend
  id: API-POST-PaymentCallback
  route: POST /api/payments/callback
  description: 第三方支付回调（占位）
  input:
    type: JSON
    body:
      orderId: string
      paymentId: string
      status: enum(success, fail)
  output:
    success:
      statusCode: 200
      body: { message: "ok" }
  dependencies:
    - DB-MarkPaymentSuccess
    - DB-UpdateOrderStatus
  acceptanceCriteria:
    - 成功支付回调后标记订单为已支付并可进入出票流程
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：支付回调接口"

- type: Backend
  id: API-POST-IssueTicket
  route: POST /api/orders/{orderId}/issue
  description: 出票（占位）
  input:
    type: Path
    path:
      orderId: string
  output:
    success:
      statusCode: 200
      body: { ticketNo: "string" }
  dependencies:
    - DB-IssueTicket
    - DB-UpdateOrderStatus
  acceptanceCriteria:
    - 出票成功后返回电子客票号并更新订单状态为已出票
  changeLog:
    - date: "2025-11-15"
      description: "新增机票模块：出票接口"

- type: Backend
  id: API-POST-SendVerificationCode
  route: POST /api/auth/send-verification-code
  description: 发送手机验证码
  input:
    type: JSON
    body:
      phoneNumber: string
      type: string
  output:
    success:
      statusCode: 200
      body: { message: "Verification code sent successfully." }
    error:
      - statusCode: 400
        body: { error: "Invalid phone number format." }
      - statusCode: 429
        body: { error: "Too many requests. Please try again later." }
  dependencies:
    - DB-CreateVerificationCode
  acceptanceCriteria:
    - 当接收到合法的手机号时，应返回200 OK并发送验证码
    - 当手机号格式不正确时，应返回400 Bad Request
    - 当请求过于频繁时，应返回429 Too Many Requests
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

- type: Backend
  id: API-POST-LoginWithCode
  route: POST /api/auth/login-with-code
  description: 处理用户验证码登录请求
  input:
    type: JSON
    body:
      phoneNumber: string
      verificationCode: string
      agreeToTerms: boolean
  output:
    success:
      statusCode: 200
      body: { userId: "uuid", token: "jwt", username: "string" }
    error:
      - statusCode: 400
        body: { error: "Invalid input format." }
      - statusCode: 401
        body: { error: "Invalid verification code." }
      - statusCode: 403
        body: { error: "Please agree to the terms of service." }
      - statusCode: 404
        body: { error: "User not found." }
  dependencies:
    - DB-FindUserByPhone
    - DB-VerifyCode
  acceptanceCriteria:
    - 当接收到合法且已注册的数据时，应返回200 OK
    - 当验证码错误时，应返回401 Unauthorized
    - 当用户未同意服务协议时，应返回403 Forbidden
    - 当用户不存在时，应返回404 Not Found
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

- type: Backend
  id: API-POST-RegisterStep1
  route: POST /api/auth/register-step1
  description: 处理注册第一步 - 验证手机号和验证码
  input:
    type: JSON
    body:
      phoneNumber: string
      verificationCode: string
  output:
    success:
      statusCode: 200
      body: { tempToken: "string", maskedPhone: "string" }
    error:
      - statusCode: 400
        body: { error: "Invalid phone number format." }
      - statusCode: 401
        body: { error: "Invalid verification code." }
  dependencies:
    - DB-VerifyCode
  acceptanceCriteria:
    - 当接收到合法的手机号和正确的验证码时，应返回200 OK
    - 当手机号格式不正确时，应返回400 Bad Request
    - 当验证码错误时，应返回401 Unauthorized
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

- type: Backend
  id: API-POST-RegisterStep2
  route: POST /api/auth/register-step2
  description: 处理注册第二步 - 设置密码
  input:
    type: JSON
    body:
      tempToken: string
      password: string
      confirmPassword: string
  output:
    success:
      statusCode: 201
      body: { userId: "uuid", token: "jwt", message: "Registration successful." }
    error:
      - statusCode: 400
        body: { error: "Password does not meet requirements." }
      - statusCode: 409
        body: { error: "Passwords do not match." }
      - statusCode: 401
        body: { error: "Invalid or expired token." }
  dependencies:
    - DB-CreateUser
  acceptanceCriteria:
    - 当接收到合法的密码且两次输入一致时，应返回201 Created
    - 当密码不符合要求时，应返回400 Bad Request
    - 当两次密码不一致时，应返回409 Conflict
    - 当临时令牌无效或过期时，应返回401 Unauthorized
  changeLog:
    - date: "2025-11-11"
      description: "初始创建"

- type: Backend
  id: API-GET-Orders
  route: GET /api/orders
  description: 获取当前用户的订单列表，支持按状态筛选和分页。
  input:
    type: QueryParams
    params:
      - name: status
        type: string
        description: "订单状态筛选 (all, pending_travel, pending_payment, pending_review)"
      - name: page
        type: integer
        description: "页码"
      - name: pageSize
        type: integer
        description: "每页数量"
  output:
    success:
      statusCode: 200
      body: {
        orders: [
          {
            orderId: "uuid",
            productType: "string",
            productTitle: "string",
            orderDate: "date",
            totalAmount: "float",
            orderStatus: "string"
          }
        ],
        pagination: {
          currentPage: "integer",
          totalPages: "integer",
          totalCount: "integer"
        }
      }
    error:
      - statusCode: 401
        body: { error: "Unauthorized. Please login." }
  dependencies:
    - DB-FindOrdersByUserId
  acceptanceCriteria:
    - 成功请求后应返回200 OK及订单列表和分页信息。
    - 未登录用户请求应返回401 Unauthorized。
  changeLog:
    - date: "2025-11-15"
      description: "初始创建。"

- type: Backend
  id: API-GET-OrderById
  route: GET /api/orders/:orderId
  description: 获取指定ID的订单详情。
  input:
    type: PathParams
    params:
      - name: orderId
        type: string
        description: "订单的唯一标识符"
  output:
    success:
      statusCode: 200
      body: {
        orderId: "uuid",
        orderStatus: "string",
        productInfo: {},
        travelerInfo: [],
        contactInfo: {},
        priceDetails: {},
        actions: ["cancel", "invoice"]
      }
    error:
      - statusCode: 401
        body: { error: "Unauthorized." }
      - statusCode: 403
        body: { error: "Forbidden. You do not have permission to view this order." }
      - statusCode: 404
        body: { error: "Order not found." }
  dependencies:
    - DB-FindOrderById
  acceptanceCriteria:
    - 成功请求后应返回200 OK及完整的订单详情。
    - 如果订单不属于当前用户，应返回403 Forbidden。
    - 如果订单ID不存在，应返回404 Not Found。
  changeLog:
    - date: "2025-11-15"
      description: "初始创建。"

- type: Backend
  id: API-POST-CancelOrder
  route: POST /api/orders/:orderId/cancel
  description: 取消一个指定的订单。
  input:
    type: PathParams
    params:
      - name: orderId
        type: string
        description: "订单的唯一标识符"
  output:
    success:
      statusCode: 200
      body: { message: "Order cancelled successfully." }
    error:
      - statusCode: 400
        body: { error: "Order cannot be cancelled in its current state." }
      - statusCode: 403
        body: { error: "Forbidden." }
      - statusCode: 404
        body: { error: "Order not found." }
  dependencies:
    - DB-FindOrderById
    - DB-UpdateOrderStatus
  acceptanceCriteria:
    - 成功取消后应返回200 OK。
    - 如果订单状态不允许取消，应返回400 Bad Request。
  changeLog:
    - date: "2025-11-15"
      description: "初始创建。"

- type: Backend
  id: API-GET-OrderAsPdf
  route: GET /api/orders/:orderId/download
  description: 下载指定订单的PDF版本。
  input:
    type: PathParams
    params:
      - name: orderId
        type: string
        description: "订单的唯一标识符"
  output:
    success:
      statusCode: 200
      headers: { "Content-Type": "application/pdf" }
      body: "PDF file stream"
    error:
      - statusCode: 404
        body: { error: "Order not found or PDF generation failed." }
  dependencies:
    - DB-FindOrderById
  acceptanceCriteria:
    - 成功请求后应返回200 OK及PDF文件流。
  changeLog:
    - date: "2025-11-15"
      description: "初始创建。"